<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Joy-Con äººç‹¼</title>

<style>
body{
  background:#111;
  color:white;
  font-family:sans-serif;
  text-align:center;
}

.player{
  display:inline-block;
  padding:18px;
  margin:10px;
  border-radius:16px;
  min-width:150px;
}

button{
  padding:10px 18px;
  font-size:18px;
  margin:6px;
}
</style>
</head>

<body>

<h1>ğŸº Joy-Con äººç‹¼ï¼ˆ1äºº1ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ï¼‰</h1>

<button onclick="connect()">ğŸ® æ¥ç¶š</button>
<button onclick="assignRoles()">ğŸ² å½¹è·é…å¸ƒ</button>

<h2 id="phase">æ¥ç¶šã—ã¦ãã ã•ã„</h2>

<div id="players"></div>

<script>

let players=[]
let phase="setup"
let votes={}

// =================
// æ¥ç¶š
// =================

async function connect(){

  const devices=await navigator.hid.requestDevice({
    filters:[{vendorId:0x057e}]
  })

  for(const d of devices){
    await d.open()

    const side = d.productId===0x2006 ? "L" : "R"

    const p={
      device:d,
      name:"Player",
      role:"",
      alive:true,
      side:side,
      color:side==="L" ? "#00aaff" : "#ff4444"
    }

    players.push(p)

    d.addEventListener("inputreport",e=>handleInput(e,p))
  }

  render()
  setPhase("åå‰å…¥åŠ› â†’ å½¹è·é…å¸ƒ")
}

// =================
// è¡¨ç¤º
// =================

function render(){

  playersDiv.innerHTML=""

  players.forEach((p,i)=>{

    const div=document.createElement("div")
    div.className="player"
    div.style.background=p.color

    div.innerHTML=
      `<input value="${p.name}"
       onchange="players[${i}].name=this.value">
       <br>${p.side} Joy-Con
       <br><b>${p.role}</b>`

    div.onclick=()=>vibrate(p.device,1)

    playersDiv.appendChild(div)
  })
}

const playersDiv=document.getElementById("players")

// =================
// å¼±æŒ¯å‹•
// =================

async function vibrate(device,times){
  const weak=new Uint8Array([0x10,0x01,0x10,0x10,0,1,0x10,0x10])

  for(let i=0;i<times;i++){
    await device.sendReport(0x10,weak)
    await new Promise(r=>setTimeout(r,120))
  }
}

// =================
// å½¹è·é…å¸ƒï¼ˆè¡¨ç¤ºã‚ã‚Šï¼‰
// =================

function assignRoles(){

  const roles=["äººç‹¼","å ã„å¸«","æ‘äºº","æ‘äºº","æ‘äºº"]

  players.forEach((p,i)=>{
    p.role=roles[i%roles.length]
  })

  render()

  setPhase("Aãƒœã‚¿ãƒ³ã§ã‚²ãƒ¼ãƒ é–‹å§‹")
  phase="ready"
}

// =================
// å…¥åŠ›å‡¦ç†
// =================

async function handleInput(e,p){

  const d=new Uint8Array(e.data.buffer)

  const A=(d[3]&0x08)!==0
  const confirm=(d[3]&0x40)!==0 || (d[3]&0x01)!==0 // R or L

  // æŒ¯å‹•ç¢ºèª
  if(confirm){
    await vibrate(p.device,1)
  }

  // æ±ºå®š
  if(A){

    if(phase==="ready"){
      startGame()
    }

    if(phase==="vote" && p.alive){
      vote(p)
    }
  }
}

// =================
// ã‚²ãƒ¼ãƒ é–‹å§‹
// =================

function startGame(){
  phase="vote"
  votes={}
  setPhase("â˜€ï¸ æŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚ºï¼šå‡¦åˆ‘ã—ãŸã„äººã®Aã‚’æŠ¼ã™")
}

// =================
// æŠ•ç¥¨
// =================

function vote(target){

  votes[target.name]=(votes[target.name]||0)+1

  const alive=players.filter(p=>p.alive).length

  if(Object.values(votes).reduce((a,b)=>a+b,0)>=alive){
    execute()
  }
}

// =================
// å‡¦åˆ‘
// =================

function execute(){

  let max=0,name=""

  for(const k in votes){
    if(votes[k]>max){
      max=votes[k]
      name=k
    }
  }

  const p=players.find(x=>x.name===name)
  p.alive=false

  setPhase(name+" ãŒå‡¦åˆ‘ã•ã‚ŒãŸ")

  checkWin()
}

// =================
// å‹æ•—
// =================

function checkWin(){

  const wolves=players.filter(p=>p.role==="äººç‹¼"&&p.alive).length
  const humans=players.filter(p=>p.role!=="äººç‹¼"&&p.alive).length

  if(wolves===0){
    setPhase("ğŸ‰ æ‘äººå‹åˆ©ï¼")
    return
  }

  if(wolves>=humans){
    setPhase("ğŸº äººç‹¼å‹åˆ©ï¼")
    return
  }

  phase="vote"
  votes={}
  setPhase("æ¬¡ã®æŠ•ç¥¨ã¸")
}

// =================
// è¡¨ç¤º
// =================

function setPhase(t){
  document.getElementById("phase").innerText=t
}

</script>
</body>
</html>
