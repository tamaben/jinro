<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Joy-Con äººç‹¼ å®Œå…¨ç‰ˆ</title>
<style>
body{
  background:#111;
  color:white;
  font-family:sans-serif;
  text-align:center;
}
.player{
  display:inline-block;
  padding:18px;
  margin:10px;
  border-radius:16px;
  min-width:140px;
}
button{padding:10px 20px;font-size:18px;margin:6px;}
</style>
</head>

<body>

<h1>ğŸº Joy-Con äººç‹¼</h1>

<button onclick="connect()">ğŸ® æ¥ç¶š</button>
<button onclick="distribute()">ğŸ² å½¹è·é…å¸ƒ</button>

<h3 id="phase">æ¥ç¶šã—ã¦ãã ã•ã„</h3>

<div id="players"></div>

<script>

let players=[]
let phase="setup"
let confirmed=0
let votes={}

// =================
// æ¥ç¶š
// =================

async function connect(){

  const devices=await navigator.hid.requestDevice({
    filters:[{vendorId:0x057e}]
  })

  for(const d of devices){
    await d.open()

    const p={
      device:d,
      name:"Player",
      role:0,
      alive:true,
      confirmed:false,
      color:getColor(d.productId),
      side:(d.productId===0x2006?"L":"R")
    }

    players.push(p)

    d.addEventListener("inputreport",e=>handleInput(e,p))
  }

  render()
  phaseText("åå‰å…¥åŠ› â†’ å½¹è·é…å¸ƒ")
}

// =================
// è‰²
// =================

function getColor(pid){
  return pid===0x2006 ? "#00aaff" : "#ff4444"
}

// =================
// UIè¡¨ç¤º
// =================

function render(){

  playersDiv.innerHTML=""

  players.forEach((p,i)=>{
    const d=document.createElement("div")
    d.className="player"
    d.style.background=p.color

    d.innerHTML=
      `<input value="${p.name}"
        onchange="players[${i}].name=this.value">
       <br>${p.side} Joy-Con`

    d.onclick=()=>vibrate(p.device,1)

    playersDiv.appendChild(d)
  })
}

const playersDiv=document.getElementById("players")

// =================
// å¼±æŒ¯å‹•
// =================

async function vibrate(device,times){
  const weak=new Uint8Array([0x10,0x01,0x10,0x10,0,1,0x10,0x10])

  for(let i=0;i<times;i++){
    await device.sendReport(0x10,weak)
    await new Promise(r=>setTimeout(r,120))
  }
}

// =================
// å½¹è·é…å¸ƒ
// =================

async function distribute(){

  phase="role"

  const roles=[1,2,2,2,3] // äººç‹¼1 å 1 ä»–æ‘äºº

  players.forEach((p,i)=>{
    p.role=roles[i%roles.length]
    p.confirmed=false
  })

  confirmed=0

  phaseText("æŒ¯å‹•ã§ç¢ºèª â†’ Aæ±ºå®š / Lå†ç¢ºèª")

  for(const p of players){
    await vibrate(p.device,p.role)
  }
}

// =================
// å…¥åŠ›
// =================

async function handleInput(e,p){

  const d=new Uint8Array(e.data.buffer)

  const A=(d[3]&0x08)!==0
  const L=(d[3]&0x01)!==0

  // å†ç¢ºèªï¼ˆLãƒœã‚¿ãƒ³ï¼‰
  if(L && phase==="role"){
    await vibrate(p.device,p.role)
  }

  // æ±ºå®šï¼ˆAãƒœã‚¿ãƒ³ï¼‰
  if(A){

    if(phase==="role" && !p.confirmed){
      p.confirmed=true
      confirmed++
      if(confirmed===players.length) startGame()
    }

    if(phase==="vote" && p.alive){
      vote(p)
    }
  }
}

// =================
// ã‚²ãƒ¼ãƒ é–‹å§‹
// =================

async function startGame(){
  phase="night"
  phaseText("ğŸŒ™ å¤œãƒ•ã‚§ãƒ¼ã‚ºï¼ˆç›®ã‚’é–‰ã˜ã‚‹ï¼‰")

  for(const p of players){
    if(p.role===1) await vibrate(p.device,3) // äººç‹¼ã ã‘è¿½åŠ é€šçŸ¥
  }

  setTimeout(dayPhase,5000)
}

// =================
// æ˜¼ãƒ•ã‚§ãƒ¼ã‚º
// =================

function dayPhase(){
  phase="vote"
  votes={}
  phaseText("â˜€ï¸ æŠ•ç¥¨ï¼ å‡¦åˆ‘ã—ãŸã„äººã®Aã‚’æŠ¼ã™")
}

// =================
// æŠ•ç¥¨
// =================

function vote(target){

  votes[target.name]=(votes[target.name]||0)+1

  if(Object.keys(votes).length>=players.filter(p=>p.alive).length){
    execute()
  }
}

// =================
// å‡¦åˆ‘
// =================

function execute(){

  let max=0
  let name=""

  for(const k in votes){
    if(votes[k]>max){
      max=votes[k]
      name=k
    }
  }

  const p=players.find(x=>x.name===name)
  p.alive=false

  phaseText(`${name} ãŒå‡¦åˆ‘ã•ã‚ŒãŸ`)

  setTimeout(checkWin,2000)
}

// =================
// å‹æ•—
// =================

function checkWin(){

  const wolves=players.filter(p=>p.role===1&&p.alive).length
  const humans=players.filter(p=>p.role!==1&&p.alive).length

  if(wolves===0){
    phaseText("ğŸ‰ æ‘äººå‹åˆ©ï¼")
    return
  }
  if(wolves>=humans){
    phaseText("ğŸº äººç‹¼å‹åˆ©ï¼")
    return
  }

  dayPhase()
}

// =================
// è¡¨ç¤º
// =================

function phaseText(t){
  document.getElementById("phase").innerText=t
}

</script>
</body>
</html>
