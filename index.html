<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Joy-Con äººç‹¼</title>

<style>
body{
  background:#111;
  color:white;
  font-family:sans-serif;
  text-align:center;
}

.player{
  display:inline-block;
  padding:20px;
  margin:15px;
  border-radius:20px;
  cursor:pointer;
  min-width:140px;
}

input{
  width:100px;
}
button{
  padding:10px 20px;
  font-size:18px;
  margin:10px;
}
</style>
</head>

<body>

<h1>ğŸº Joy-Con äººç‹¼</h1>

<button onclick="connect()">ğŸ® Joy-Conæ¥ç¶š</button>
<button onclick="startRoles()">ğŸ² å½¹è·é…å¸ƒ</button>

<div id="players"></div>

<script>

let joycons = []


// ===== æ¥ç¶š =====
async function connect(){

  const devices = await navigator.hid.requestDevice({
    filters:[{vendorId:0x057e}]
  })

  for(const d of devices){

    await d.open()

    const color = getColor(d.productId)

    joycons.push({
      device:d,
      name:"Player",
      color:color
    })
  }

  render()
}


// ===== è‰²æ¨å®š =====
function getColor(pid){
  if(pid === 0x2006) return "#00aaff" // L é’
  if(pid === 0x2007) return "#ff4444" // R èµ¤
  return "#888"
}


// ===== è¡¨ç¤º =====
function render(){

  players.innerHTML=""

  joycons.forEach((j,i)=>{

    const div = document.createElement("div")
    div.className="player"
    div.style.background=j.color

    div.innerHTML=`
      <input value="${j.name}"
             onchange="joycons[${i}].name=this.value">
      <br><small>ã‚¿ãƒƒãƒ—ã§æŒ¯å‹•ç¢ºèª</small>
    `

    div.onclick=()=> vibrate(j.device,1)

    players.appendChild(div)
  })
}


// ===== è¶…å¼±ä¸€ç¬æŒ¯å‹• =====
async function vibrate(device,times){

  // ã‹ãªã‚Šå¼±ã‚ãƒ‘ã‚±ãƒƒãƒˆ
  const data = new Uint8Array([
    0x10,0x01,0x10,0x10,0x00,0x01,0x10,0x10
  ])

  for(let i=0;i<times;i++){
    await device.sendReport(0x10,data)
    await new Promise(r=>setTimeout(r,120))
  }
}


// ===== å½¹è·é…å¸ƒ =====
async function startRoles(){

  const roles = [1,2,3,4,5]

  for(const j of joycons){

    const r = roles[Math.floor(Math.random()*roles.length)]

    await vibrate(j.device,r)
  }

  alert("æŒ¯å‹•å›æ•°ã§å½¹è·ã‚’ç¢ºèªã—ã¦ãã ã•ã„")
}

</script>

</body>
</html>
