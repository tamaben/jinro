<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Joy-Con äººç‹¼</title>

<style>
body{
  background:#111;
  color:white;
  font-family:sans-serif;
  text-align:center;
}

.player{
  display:inline-block;
  padding:18px;
  margin:12px;
  border-radius:18px;
  min-width:140px;
  cursor:pointer;
}

input{
  width:100px;
  text-align:center;
}

button{
  padding:10px 18px;
  font-size:18px;
  margin:8px;
}
</style>
</head>

<body>

<h1>ğŸº Joy-Con äººç‹¼</h1>

<button onclick="connect()">ğŸ® æ¥ç¶š</button>
<button onclick="distribute()">ğŸ² å½¹è·é…å¸ƒ</button>

<h3 id="rule">
ã€å½¹è·ã€‘<br>
1å›:äººç‹¼ã€€2å›:æ‘äººã€€3å›:å ã„å¸«ã€€4å›:é¨å£«ã€€5å›:ç‹‚äºº<br>
Aãƒœã‚¿ãƒ³: æ±ºå®šã€€Rãƒœã‚¿ãƒ³: å†ç¢ºèª
</h3>

<div id="players"></div>
<p id="msg">Joy-Conã‚’æ¥ç¶šã—ã¦ãã ã•ã„</p>

<script>

let joycons=[]
let confirmed=0


// =======================
// æ¥ç¶š
// =======================

async function connect(){

  const devices = await navigator.hid.requestDevice({
    filters:[{vendorId:0x057e}]
  })

  for(const d of devices){

    await d.open()

    const jc={
      device:d,
      name:"Player",
      role:0,
      confirmed:false,
      color:getColor(d.productId)
    }

    joycons.push(jc)

    d.addEventListener("inputreport",e=>handleInput(e,jc))
  }

  render()
  msg.innerText="åå‰å…¥åŠ› â†’ å½¹è·é…å¸ƒ"
}


// =======================
// è‰²åˆ¤å®š
// =======================

function getColor(pid){
  if(pid===0x2006) return "#00aaff"
  if(pid===0x2007) return "#ff4444"
  return "#888"
}


// =======================
// è¡¨ç¤º
// =======================

function render(){

  players.innerHTML=""

  joycons.forEach((j,i)=>{

    const div=document.createElement("div")
    div.className="player"
    div.style.background=j.color

    div.innerHTML=`
      <input value="${j.name}"
      onchange="joycons[${i}].name=this.value">
      <br><small>ã‚¿ãƒƒãƒ—ã§æŒ¯å‹•ç¢ºèª</small>
    `

    div.onclick=()=>vibrate(j.device,1)

    players.appendChild(div)
  })
}


// =======================
// å¼±æŒ¯å‹•
// =======================

async function vibrate(device,times){

  const weak=new Uint8Array([
    0x10,0x01,0x10,0x10,0x00,0x01,0x10,0x10
  ])

  for(let i=0;i<times;i++){
    await device.sendReport(0x10,weak)
    await new Promise(r=>setTimeout(r,120))
  }
}


// =======================
// å½¹è·é…å¸ƒ
// =======================

async function distribute(){

  confirmed=0

  for(const j of joycons){
    j.role=Math.floor(Math.random()*5)+1
    j.confirmed=false
  }

  msg.innerText="æŒ¯å‹•ã§å½¹è·ç¢ºèª â†’ Aã§æ±ºå®š / Rã§å†ç¢ºèª"

  for(const j of joycons){
    await vibrate(j.device,j.role)
  }
}


// =======================
// ãƒœã‚¿ãƒ³å…¥åŠ›
// =======================

async function handleInput(e,j){

  const d = new Uint8Array(e.data.buffer)

  const A = (d[3] & 0x08) !== 0
  const R = (d[3] & 0x40) !== 0

  // R â†’ å†ç¢ºèª
  if(R){
    await vibrate(j.device,j.role)
  }

  // A â†’ æ±ºå®š
  if(A && !j.confirmed){
    j.confirmed=true
    confirmed++
    msg.innerText=`ç¢ºèªä¸­â€¦ ${confirmed}/${joycons.length}`

    await vibrate(j.device,1)

    if(confirmed===joycons.length){
      startGame()
    }
  }
}


// =======================
// ã‚²ãƒ¼ãƒ é–‹å§‹
// =======================

async function startGame(){

  msg.innerText="ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ï¼ï¼ ğŸº"

  // é–‹å§‹åˆå›³
  for(const j of joycons){
    await vibrate(j.device,2)
  }
}

</script>

</body>
</html>
